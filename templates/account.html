{% extends "base.html" %}
{% block main_content %}

<div class="account-container" style="max-width: 600px; margin: 0 auto; padding: 20px; color: white;">

    <h2 class="section-title" style="margin-bottom: 20px;">Настройки аккаунта</h2>

    <!-- Текущая аватарка и кнопка изменить -->
    <div class="current-avatar" style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
        <img src="{{ url_for('static', filename='avatars/' + selected_avatar) }}" 
             alt="Аватар" id="current-avatar" 
             style="width:100px; height:100px; border-radius:50%; border:2px solid red; object-fit:cover;">
             <div class="account-header">
                <h2>@{{ current_username }}</h2>

                {% if current_user.username == "admin" %}
                    <a href="{{ url_for('admin_panel') }}" class="admin-btn">Admin Panel</a>
                {% endif %}
            </div>

        <button id="change-avatar-btn" type="button" 
                style="background:red; padding: 10px 16px; border-radius:8px; font-weight:bold; cursor:pointer;">
            Изменить аватар
        </button>
    </div>

    <!-- Скрытое меню выбора аватарок -->
    <form method="POST" class="avatar-form" id="avatar-menu" style="display: none; margin-bottom: 30px;">
        <h3 style="margin-bottom: 15px;">Выберите аватар</h3>
        <div class="avatar-list" style="display:flex; flex-wrap:wrap; gap:15px;">
            {% for avatar in avatars %}
            <label class="avatar-item" style="cursor:pointer; display:flex; flex-direction:column; align-items:center;">
                <input type="radio" name="avatar" value="{{ avatar }}" style="display:none;" {% if avatar == selected_avatar %}checked{% endif %}>
                <img src="{{ url_for('static', filename='avatars/' + avatar) }}" 
                     alt="{{ avatar }}" 
                     style="border-radius:50%; width:80px; height:80px; border:2px solid {% if avatar == selected_avatar %}red{% else %}transparent{% endif %}; transition: transform 0.2s;">
            </label>
            {% endfor %}
        </div>
        <button type="submit" style="margin-top:20px; background:red; border:none; border-radius:8px; padding:10px 16px; font-weight:bold; color:white;">
            Сохранить выбор
        </button>
    </form>

    <hr style="border:none; height:1px; background-color:#444; margin:20px 0;">

    <!-- Изменение username -->
    <form method="POST" id="username-form" style="margin-bottom: 20px;">
        <h3 style="margin-bottom: 10px;">Изменить имя пользователя</h3>
        <input type="text" name="username" id="username" placeholder="Новый username" 
               style="width:100%; padding:10px; border-radius:8px; border:none; background:#1c1c1c; color:white; margin-bottom:5px;">
        <div id="username-feedback" style="font-size:12px; margin-bottom:10px;"></div>
        <button type="submit" style="background:blue; color:white; border:none; border-radius:8px; padding:10px 16px; font-weight:bold;">
            Сохранить
        </button>
    </form>

    <hr style="border:none; height:1px; background-color:#444; margin:20px 0;">

    <!-- Изменение пароля -->
    <form method="POST" id="password-form" style="margin-bottom: 20px;">
        <h3 style="margin-bottom: 10px;">Изменить пароль</h3>
        <input type="password" name="new_password" id="new_password" placeholder="Новый пароль" 
               style="width:100%; padding:10px; border-radius:8px; border:none; background:#1c1c1c; color:white; margin-bottom:5px;">
        <input type="password" name="confirm_password" id="confirm_password" placeholder="Подтвердите пароль" 
               style="width:100%; padding:10px; border-radius:8px; border:none; background:#1c1c1c; color:white; margin-bottom:5px;">
        <div id="password-feedback" style="font-size:12px; margin-bottom:10px;"></div>
        <button type="submit" style="background:orange; color:white; border:none; border-radius:8px; padding:10px 16px; font-weight:bold;">
            Сменить пароль
        </button>
    </form>

    <hr style="border:none; height:1px; background-color:#444; margin:20px 0;">

    <!-- Кнопка Выйти -->
    <form method="POST" action="{{ url_for('logout') }}">
        <button type="submit" style="background:#555; color:white; border:none; border-radius:8px; padding:10px 16px; font-weight:bold; cursor:pointer;">
            Выйти
        </button>
    </form>

</div>

<script>
    // ==== Аватарки ====
    const changeBtn = document.getElementById('change-avatar-btn');
    const avatarMenu = document.getElementById('avatar-menu');

    changeBtn.addEventListener('click', () => {
        if (avatarMenu.style.display === 'none') {
            avatarMenu.style.display = 'block';
            changeBtn.textContent = 'Скрыть выбор аватарок';
        } else {
            avatarMenu.style.display = 'none';
            changeBtn.textContent = 'Изменить аватар';
        }
    });

    const avatarItems = avatarMenu.querySelectorAll('.avatar-item input');
    avatarItems.forEach(input => {
        input.addEventListener('change', () => {
            avatarItems.forEach(i => i.nextElementSibling.style.borderColor = 'transparent');
            input.nextElementSibling.style.borderColor = 'red';
            document.getElementById('current-avatar').src = input.nextElementSibling.src;
        });
    });

    // ==== Username ====
    const usernameForm = document.getElementById('username-form');
    const usernameInput = document.getElementById('username');
    const usernameFeedback = document.getElementById('username-feedback');

    usernameInput.addEventListener('input', () => {
        usernameInput.value = usernameInput.value.toLowerCase();
    });

    usernameForm.addEventListener('submit', (e) => {
        e.preventDefault();
        usernameFeedback.textContent = '';
        usernameFeedback.style.color = 'red';

        const username = usernameInput.value.trim();
        const re = /^[a-z0-9_]{4,10}$/;

        if (!re.test(username)) {
            usernameFeedback.textContent = "Username: 4-10 символов, латиница, цифры, _";
            return;
        }

        // Проверка на сервере, JSON
        fetch('{{ url_for("check_username") }}', {
            method: 'POST',
            headers: {'Content-Type':'application/x-www-form-urlencoded'},
            body: new URLSearchParams({'username': username})
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.status === "taken") {
                usernameFeedback.textContent = 'Такой username уже занят';
            } else if (data.status === "invalid") {
                usernameFeedback.textContent = 'Username: 4-10 символов, латиница, цифры, _';
            } else {
                usernameFeedback.style.color = 'lime';
                usernameFeedback.textContent = 'Username успешно изменён';

                // Отправляем форму на сервер для сохранения
                fetch('{{ url_for("account") }}', {
                    method: 'POST',
                    headers: {'Content-Type':'application/x-www-form-urlencoded'},
                    body: new URLSearchParams({'username': username})
                });
            }
        });
    });

    // ==== Пароль ====
    const passwordForm = document.getElementById('password-form');
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const passwordFeedback = document.getElementById('password-feedback');

    passwordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        passwordFeedback.textContent = '';
        passwordFeedback.style.color = 'red';

        const re = /^[a-zA-Z0-9]{6,32}$/;
        if (!re.test(newPassword.value)) {
            passwordFeedback.textContent = "Пароль: 6-32 символа, латиница и цифры";
            return;
        }
        if (newPassword.value !== confirmPassword.value) {
            passwordFeedback.textContent = "Пароли не совпадают";
            return;
        }

        // Отправка на сервер через fetch
        fetch('{{ url_for("account") }}', {
            method: 'POST',
            headers: {'Content-Type':'application/x-www-form-urlencoded'},
            body: new URLSearchParams({'new_password': newPassword.value, 'confirm_password': confirmPassword.value})
        })
        .then(resp => {
            passwordFeedback.style.color = 'lime';
            passwordFeedback.textContent = 'Пароль успешно обновлен';
            newPassword.value = '';
            confirmPassword.value = '';
        });
    });
</script>

{% endblock %}
