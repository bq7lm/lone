{% extends "base.html" %}
{% block main_content %}

<div class="account-container" style="max-width: 600px; margin: 0 auto; padding: 20px; color: white;">

    <h2 class="section-title" style="margin-bottom: 20px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>

    <!-- –¢–µ–∫—É—â–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞ –∏ –∫–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å -->
    <div class="current-avatar" style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
        <img src="{{ url_for('static', filename='avatars/' + selected_avatar) }}" 
             alt="–ê–≤–∞—Ç–∞—Ä" id="current-avatar" 
             style="width:100px; height:100px; border-radius:50%; border:2px solid red; object-fit:cover;">
        <div class="account-header">
            <h2>@{{ current_username }}</h2>
            {% if current_user.username == "admin" %}
                <a href="{{ url_for('admin_panel') }}" class="admin-btn">Admin Panel</a>
            {% endif %}
        </div>
    </div>

    <!-- –ö–ù–û–ü–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô (–ù–û–í–ê–Ø) -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1c1c1c; border-radius: 10px;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 style="margin: 0; color: white;">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                <p style="margin: 5px 0 0 0; color: #999; font-size: 14px;">
                    –ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
                </p>
            </div>
            <button id="notification-btn" onclick="handleNotificationClick()" 
                    style="background: #075e54; color: white; border: none; border-radius: 20px; padding: 10px 20px; font-weight: bold; cursor: pointer;">
                ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...
            </button>
        </div>
        <div id="notification-status" style="margin-top: 10px; font-size: 13px; color: #999;">
            –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä -->
    <button id="change-avatar-btn" type="button" 
            style="background:red; padding: 10px 16px; border-radius:8px; font-weight:bold; cursor: pointer; width: 100%; margin-bottom: 20px; border: none; color: white;">
        –ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
    </button>

    <!-- –°–∫—Ä—ã—Ç–æ–µ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–æ–∫ -->
    <form method="POST" class="avatar-form" id="avatar-menu" style="display: none; margin-bottom: 30px;">
        <h3 style="margin-bottom: 15px;">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</h3>
        <div class="avatar-list" style="display:flex; flex-wrap:wrap; gap:15px;">
            {% for avatar in avatars %}
            <label class="avatar-item" style="cursor:pointer; display:flex; flex-direction:column; align-items:center;">
                <input type="radio" name="avatar" value="{{ avatar }}" style="display:none;" {% if avatar == selected_avatar %}checked{% endif %}>
                <img src="{{ url_for('static', filename='avatars/' + avatar) }}" 
                     alt="{{ avatar }}" 
                     style="border-radius:50%; width:80px; height:80px; border:2px solid {% if avatar == selected_avatar %}red{% else %}transparent{% endif %}; transition: transform 0.2s;">
            </label>
            {% endfor %}
        </div>
        <button type="submit" style="margin-top:20px; background:red; border:none; border-radius:8px; padding:10px 16px; font-weight:bold; color:white;">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä
        </button>
    </form>

    <hr style="border:none; height:1px; background-color:#444; margin:20px 0;">

    <!-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ username -->
    <form method="POST" id="username-form" style="margin-bottom: 20px;">
        <h3 style="margin-bottom: 10px;">–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <input type="text" name="username" id="username" placeholder="–ù–æ–≤—ã–π username" 
               style="width:100%; padding:10px; border-radius:8px; border:none; background:#1c1c1c; color:white; margin-bottom:5px;">
        <div id="username-feedback" style="font-size:12px; margin-bottom:10px;"></div>
        <button type="submit" style="background:blue; color:white; border:none; border-radius:8px; padding:10px 16px; font-weight:bold;">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
    </form>

    <hr style="border:none; height:1px; background-color:#444; margin:20px 0;">

    <!-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è -->
    <form method="POST" id="password-form" style="margin-bottom: 20px;">
        <h3 style="margin-bottom: 10px;">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h3>
        <input type="password" name="new_password" id="new_password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" 
               style="width:100%; padding:10px; border-radius:8px; border:none; background:#1c1c1c; color:white; margin-bottom:5px;">
        <input type="password" name="confirm_password" id="confirm_password" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" 
               style="width:100%; padding:10px; border-radius:8px; border:none; background:#1c1c1c; color:white; margin-bottom:5px;">
        <div id="password-feedback" style="font-size:12px; margin-bottom:10px;"></div>
        <button type="submit" style="background:orange; color:white; border:none; border-radius:8px; padding:10px 16px; font-weight:bold;">
            –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
        </button>
    </form>

    <hr style="border:none; height:1px; background-color:#444; margin:20px 0;">

    <!-- –ö–Ω–æ–ø–∫–∞ –í—ã–π—Ç–∏ -->
    <form method="POST" action="{{ url_for('logout') }}">
        <button type="submit" style="background:#555; color:white; border:none; border-radius:8px; padding:10px 16px; font-weight:bold; cursor:pointer; width: 100%;">
            –í—ã–π—Ç–∏
        </button>
    </form>

</div>

<script>
    // ==== –ê–≤–∞—Ç–∞—Ä–∫–∏ ====
    const changeBtn = document.getElementById('change-avatar-btn');
    const avatarMenu = document.getElementById('avatar-menu');

    changeBtn.addEventListener('click', () => {
        if (avatarMenu.style.display === 'none') {
            avatarMenu.style.display = 'block';
            changeBtn.textContent = '–°–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–æ–∫';
        } else {
            avatarMenu.style.display = 'none';
            changeBtn.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä';
        }
    });

    const avatarItems = avatarMenu.querySelectorAll('.avatar-item input');
    avatarItems.forEach(input => {
        input.addEventListener('change', () => {
            avatarItems.forEach(i => i.nextElementSibling.style.borderColor = 'transparent');
            input.nextElementSibling.style.borderColor = 'red';
            document.getElementById('current-avatar').src = input.nextElementSibling.src;
        });
    });

    // ==== Username ====
    const usernameForm = document.getElementById('username-form');
    const usernameInput = document.getElementById('username');
    const usernameFeedback = document.getElementById('username-feedback');

    usernameInput.addEventListener('input', () => {
        usernameInput.value = usernameInput.value.toLowerCase();
    });

    usernameForm.addEventListener('submit', (e) => {
        e.preventDefault();
        usernameFeedback.textContent = '';
        usernameFeedback.style.color = 'red';

        const username = usernameInput.value.trim();
        const re = /^[a-z0-9_]{4,10}$/;

        if (!re.test(username)) {
            usernameFeedback.textContent = "Username: 4-10 —Å–∏–º–≤–æ–ª–æ–≤, –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, _";
            return;
        }

        fetch('{{ url_for("check_username") }}', {
            method: 'POST',
            headers: {'Content-Type':'application/x-www-form-urlencoded'},
            body: new URLSearchParams({'username': username})
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.status === "taken") {
                usernameFeedback.textContent = '–¢–∞–∫–æ–π username —É–∂–µ –∑–∞–Ω—è—Ç';
            } else if (data.status === "invalid") {
                usernameFeedback.textContent = 'Username: 4-10 —Å–∏–º–≤–æ–ª–æ–≤, –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, _';
            } else {
                usernameFeedback.style.color = 'lime';
                usernameFeedback.textContent = '‚úÖ Username —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω';

                fetch('{{ url_for("account") }}', {
                    method: 'POST',
                    headers: {'Content-Type':'application/x-www-form-urlencoded'},
                    body: new URLSearchParams({'username': username})
                }).then(() => {
                    setTimeout(() => location.reload(), 1000);
                });
            }
        });
    });

    // ==== –ü–∞—Ä–æ–ª—å ====
    const passwordForm = document.getElementById('password-form');
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const passwordFeedback = document.getElementById('password-feedback');

    passwordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        passwordFeedback.textContent = '';
        passwordFeedback.style.color = 'red';

        const re = /^[a-zA-Z0-9]{6,32}$/;
        if (!re.test(newPassword.value)) {
            passwordFeedback.textContent = "–ü–∞—Ä–æ–ª—å: 6-32 —Å–∏–º–≤–æ–ª–∞, –ª–∞—Ç–∏–Ω–∏—Ü–∞ –∏ —Ü–∏—Ñ—Ä—ã";
            return;
        }
        if (newPassword.value !== confirmPassword.value) {
            passwordFeedback.textContent = "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç";
            return;
        }

        fetch('{{ url_for("account") }}', {
            method: 'POST',
            headers: {'Content-Type':'application/x-www-form-urlencoded'},
            body: new URLSearchParams({'new_password': newPassword.value})
        })
        .then(resp => {
            passwordFeedback.style.color = 'lime';
            passwordFeedback.textContent = '‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω';
            newPassword.value = '';
            confirmPassword.value = '';
        });
    });

    // ==== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (–ù–û–í–´–ô –ö–û–î) ====
    function handleNotificationClick() {
        if (!('Notification' in window)) {
            alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
            return;
        }
        
        if (Notification.permission === 'granted') {
            // –ï—Å–ª–∏ —É–∂–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ
            showTestNotification();
        } else {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
            window.requestNotificationPermission().then(granted => {
                if (granted) {
                    updateNotificationButton();
                    showTestNotification();
                }
            });
        }
    }
    
    function showTestNotification() {
        if (Notification.permission === 'granted') {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const testNotification = new Notification('Lone Messenger', {
                body: '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç!',
                icon: '/static/icons/icon-192.png',
                badge: '/static/icons/icon-72.png',
                vibrate: [200, 100, 200]
            });
            
            setTimeout(() => testNotification.close(), 3000);
        }
    }
    
    function updateNotificationButton() {
        const btn = document.getElementById('notification-btn');
        const status = document.getElementById('notification-status');
        
        if (Notification.permission === 'granted') {
            btn.textContent = '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã';
            btn.style.background = '#2e7d32';
            status.textContent = '‚úì –í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö';
            status.style.color = '#4caf50';
        } else if (Notification.permission === 'denied') {
            btn.textContent = '‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω—ã';
            btn.style.background = '#c62828';
            status.textContent = '‚ö†Ô∏è –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –†–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
            status.style.color = '#ff9800';
        } else {
            btn.textContent = 'üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
            btn.style.background = '#075e54';
            status.textContent = '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö';
            status.style.color = '#999';
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        updateNotificationButton();
    });
</script>

{% endblock %}