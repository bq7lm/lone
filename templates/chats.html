{% extends "base.html" %}

{% block main_content %}

<div class="section-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
    <img src="{{ url_for('static', filename='lone-icon.png') }}" alt="Чаты" style="width: 28px; height: 28px;">
    <h2 class="section-title" style="margin: 0; font-size: 20px;">Lone</h2>
</div>

<hr style="width: 100%; height: 1px; background-color: #444; border: none; margin: 0 0 20px 0;">

{% if users|length == 0 %}
<div class="chat-empty-wrapper" style="padding: 20px; text-align: center; color: #ccc; font-size: 14px;">
    <span>Нажмите 
        <img src="{{ url_for('static', filename='magnifying_glass.png') }}" alt="Поиск" style="width:16px; height:16px; vertical-align:middle; margin:0 4px;">
        чтобы найти друзей
    </span>
</div>
{% endif %}

<div class="chat-list" style="display: flex; flex-direction: column; gap: 10px;">
    {% for user in users %}
    <a href="{{ url_for('chat', user_id=user[0]) }}" class="chat-item" data-user-id="{{ user[0] }}" style="display:flex; align-items:center; gap:10px; padding:10px; border-radius:8px; text-decoration:none; color:white; background:#111;">
        <div class="avatar">
            <img src="{{ url_for('static', filename='avatars/' + user[2]) }}" alt="{{ user[1] }}" style="width:45px; height:45px; border-radius:50%; border:2px solid red; object-fit:cover;">
        </div>
        <div class="chat-info" style="flex:1;">
            <div class="chat-name" style="font-weight:bold;">{{ user[1] }}</div>
            <div class="chat-preview" style="font-size:12px; opacity:0.6;">Нажмите чтобы открыть диалог</div>
        </div>
        {% if user[4] %}
        <span class="new-message-dot"></span>
        {% endif %}
    </a>
    {% endfor %}
</div>

<!-- Звук уведомления -->
<audio id="notif-sound" src="{{ url_for('static', filename='notif.mp3') }}" preload="auto"></audio>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
socket.on('connect', () => console.log('Socket connected'));

// уведомление о новом сообщении
socket.on('new_message_notification', function(data) {
    const chatItem = document.querySelector(`.chat-item[data-user-id='${data.sender}']`);
    if (chatItem && !chatItem.querySelector('.new-message-dot')) {
        const dot = document.createElement('span');
        dot.classList.add('new-message-dot');
        chatItem.appendChild(dot);

        // звук уведомления
        const sound = document.getElementById('notif-sound');
        if (sound) sound.play();
    }
});

// клик по чату → помечаем сообщения прочитанными
document.querySelectorAll('.chat-item').forEach(item => {
    item.addEventListener('click', () => {
        const dot = item.querySelector('.new-message-dot');
        if(dot) dot.remove();
        const userId = parseInt(item.dataset.userId);
        socket.emit('mark_read', {user_id: userId});
    });
});
</script>

<style>
.new-message-dot {
    width: 10px;
    height: 10px;
    background: #1e90ff;
    border-radius: 50%;
    margin-left: auto;
}
</style>

{% endblock %}
