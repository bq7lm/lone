<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Lone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="app-wrapper">
    {% block content %}
        {% if current_user.is_authenticated %}
            <div class="main">
                {% block main_content %}{% endblock %}
            </div>

            <div class="bottom-nav">
                <a href="{{ url_for('chats') }}" class="bottom-nav-item" title="Чаты">
                    <img src="{{ url_for('static', filename='chats.png') }}" alt="Чаты" class="bottom-nav-icon">
                </a>
                <a href="{{ url_for('search') }}" class="bottom-nav-item" title="Поиск">
                    <img src="{{ url_for('static', filename='magnifying_glass.png') }}" alt="Поиск" class="bottom-nav-icon">
                </a>
                <a href="{{ url_for('account') }}" class="bottom-nav-item avatar-nav" title="Аккаунт">
                    <img src="{{ url_for('static', filename='avatars/' + current_user.avatar) }}" alt="Аватар" class="avatar-nav-img">
                </a>
            </div>

            <!-- Глобальный звук уведомлений -->
            <audio id="notif-sound" src="{{ url_for('static', filename='notif.mp3') }}" preload="auto"></audio>

            <!-- Socket.IO глобальный скрипт -->
            <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
            <script>
            document.addEventListener("DOMContentLoaded", () => {
                const socket = io();
                const currentUserId = {{ current_user.id }};
                socket.emit("join", {room: `user_${currentUserId}`});

                socket.on("new_message_notification", data => {
                    const senderId = data.sender;

                    // если находимся в чате с этим пользователем
                    const chatPageUserId = {{ user_id if 'user_id' in globals() else 'null' }};
                    if(senderId !== chatPageUserId){
                        // находим чат в списке и добавляем dot
                        const chatItem = document.querySelector(`.chat-item[data-user-id='${senderId}']`);
                        if(chatItem && !chatItem.querySelector('.new-message-dot')){
                            const dot = document.createElement('span');
                            dot.classList.add('new-message-dot');
                            chatItem.appendChild(dot);

                            // проигрываем звук
                            const sound = document.getElementById('notif-sound');
                            if(sound) sound.play().catch(e => console.log(e));
                        }
                    }
                });
            });
            </script>

        {% else %}
            <div class="auth-container">
                {% block auth_content %}{% endblock %}
            </div>
        {% endif %}
    {% endblock %}
</div>

</body>
</html>
