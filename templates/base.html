<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Lone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="app-wrapper">
    {% block content %}
        {% if current_user.is_authenticated %}
            <!-- Основной контент приложения -->
            <div class="main">
                {% block main_content %}{% endblock %}
            </div>

            <!-- Нижняя панель -->
            <div class="bottom-nav">
                <a href="{{ url_for('chats') }}" class="bottom-nav-item" title="Чаты">
                    <img src="{{ url_for('static', filename='chats.png') }}" alt="Чаты" class="bottom-nav-icon">
                </a>
                <a href="{{ url_for('search') }}" class="bottom-nav-item" title="Поиск">
                    <img src="{{ url_for('static', filename='magnifying_glass.png') }}" alt="Поиск" class="bottom-nav-icon">
                </a>
                <a href="{{ url_for('account') }}" class="bottom-nav-item avatar-nav" title="Аккаунт">
                    <img src="{{ url_for('static', filename='avatars/' + current_user.avatar) }}" alt="Аватар" class="avatar-nav-img">
                </a>
            </div>

            <!-- Глобальный скрипт Socket.IO -->
            <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
            <audio id="notif-sound" src="{{ url_for('static', filename='notif.mp3') }}" preload="auto"></audio>
            <script>
                const socket = io();
                socket.on('connect', () => console.log('Socket connected'));

                // уведомление о новом сообщении
                socket.on('new_message_notification', function(data) {
                    // ищем чат в списке, если есть
                    const chatItem = document.querySelector(`.chat-item[data-user-id='${data.sender}']`);
                    if (chatItem && !chatItem.querySelector('.new-message-dot')) {
                        const dot = document.createElement('span');
                        dot.classList.add('new-message-dot');
                        chatItem.appendChild(dot);
                    }

                    // звук уведомления
                    const sound = document.getElementById('notif-sound');
                    if (sound) sound.play();
                });
            </script>

        {% else %}
            <!-- Форма авторизации -->
            <div class="auth-container">
                {% block auth_content %}{% endblock %}
            </div>
        {% endif %}
    {% endblock %}
</div>

</body>
</html>
