<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Lone</title>
    
    <!-- Мета теги для PWA и мобильных устройств -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lone">
    <meta name="theme-color" content="#075e54">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Манифест -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <!-- Иконки для iOS -->
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="apple-touch-icon" sizes="152x152" href="{{ url_for('static', filename='icons/icon-152.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="apple-touch-icon" sizes="167x167" href="{{ url_for('static', filename='icons/icon-152.png') }}">
    
    <!-- Основной CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="app-wrapper">
    {% block content %}
        {% if current_user.is_authenticated %}
            <!-- Основной контент приложения -->
            <div class="main">
                {% block main_content %}{% endblock %}
            </div>

            <!-- Нижняя панель -->
            <div class="bottom-nav">
                <a href="{{ url_for('chats') }}" class="bottom-nav-item" title="Чаты">
                    <img src="{{ url_for('static', filename='chats.png') }}" alt="Чаты" class="bottom-nav-icon">
                </a>
                <a href="{{ url_for('search') }}" class="bottom-nav-item" title="Поиск">
                    <img src="{{ url_for('static', filename='magnifying_glass.png') }}" alt="Поиск" class="bottom-nav-icon">
                </a>
                <a href="{{ url_for('account') }}" class="bottom-nav-item avatar-nav" title="Аккаунт">
                    <img src="{{ url_for('static', filename='avatars/' + current_user.avatar) }}" alt="Аватар" class="avatar-nav-img">
                </a>
            </div>

            <!-- Глобальный скрипт Socket.IO -->
            <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
            <audio id="notif-sound" src="{{ url_for('static', filename='notif.mp3') }}" preload="auto"></audio>
            <script>
                const socket = io();
                socket.on('connect', () => console.log('Socket connected'));

                // уведомление о новом сообщении
                socket.on('new_message_notification', function(data) {
                    // ищем чат в списке, если есть
                    const chatItem = document.querySelector(`.chat-item[data-user-id='${data.sender}']`);
                    if (chatItem && !chatItem.querySelector('.new-message-dot')) {
                        const dot = document.createElement('span');
                        dot.classList.add('new-message-dot');
                        chatItem.appendChild(dot);
                    }

                    // звук уведомления
                    const sound = document.getElementById('notif-sound');
                    if (sound) sound.play();
                });
            </script>

        {% else %}
            <!-- Форма авторизации -->
            <div class="auth-container">
                {% block auth_content %}{% endblock %}
            </div>
        {% endif %}
    {% endblock %}
</div>

<!-- Service Worker регистрация - всегда загружается -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/static/sw.js')
                .then(function(registration) {
                    console.log('✅ ServiceWorker зарегистрирован:', registration.scope);
                })
                .catch(function(err) {
                    console.log('❌ Ошибка регистрации ServiceWorker:', err);
                });
        });
    }
    
    // Глобальная функция запроса уведомлений
    window.requestNotificationPermission = function() {
        if (!('Notification' in window)) {
            console.log('Этот браузер не поддерживает уведомления');
            alert('Ваш браузер не поддерживает уведомления');
            return Promise.reject('Not supported');
        }
        
        return Notification.requestPermission().then(function(permission) {
            if (permission === 'granted') {
                console.log('✅ Уведомления разрешены');
                subscribeUserToPush();
                return true;
            } else {
                console.log('❌ Уведомления запрещены');
                return false;
            }
        });
    };
    
    // Подписка на пуш-уведомления
    async function subscribeUserToPush() {
        try {
            const registration = await navigator.serviceWorker.ready;
            
            // Получаем публичный ключ VAPID из meta тега или переменной
            const applicationServerKey = 'BKGdWPoM2lmfZBGVKxNZXN93q1fLJBvENyGL7FlRQWdVAJeT1NK0JzzqgGemHTInnlcTqZ2kTZlczlPRwccv-Mk';
            
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: new Uint8Array(applicationServerKey.match(/.{1,2}/g).map(byte => parseInt(byte, 16)))
            });
            
            console.log('✅ Подписка на push получена');
            
            // Отправляем подписку на сервер
            fetch('/subscribe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(subscription)
            }).then(response => {
                if (response.ok) {
                    console.log('✅ Подписка отправлена на сервер');
                }
            });
        } catch (err) {
            console.log('❌ Ошибка подписки на push:', err);
        }
    }
    
    // Проверяем статус уведомлений при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        if ('Notification' in window && Notification.permission === 'granted') {
            console.log('ℹ️ Уведомления уже включены');
        }
    });
</script>

</body>
</html>