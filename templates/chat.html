{% extends "base.html" %}
{% block content %}

<div class="chat-container">
    <div class="chat-header" style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <img src="{{ url_for('static', filename='avatars/' + partner_avatar) }}" class="chat-avatar" alt="{{ partner }}">
            <span class="chat-name">{{ partner }}</span>
        </div>
        <a href="{{ url_for('chats') }}" class="bottom-nav-item" title="Чаты">
            <img src="{{ url_for('static', filename='lone-icon.png') }}" class="bottom-nav-icon" alt="Чаты">
        </a>
    </div>

    <div id="chat" class="chat-box">
        {% for msg in messages %}
            <div class="message {% if msg[0] == current_user.id %}me{% else %}other{% endif %}">
                {{ msg[1] }}
                <div class="message-time">{{ msg[2] }}</div>
            </div>
        {% endfor %}
    </div>

    <div class="message-input">
        <input id="message" placeholder="Написать сообщение...">
        <button onclick="sendMessage()">➤</button>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
const room = "{{ room }}";

socket.emit("join", {room: room});

function sendMessage() {
    const input = document.getElementById("message");
    if(!input.value.trim()) return;
    socket.emit("send_message", {receiver: {{ user_id }}, text: input.value});
    input.value = "";
}

socket.on("receive_message", data => {
    const chat = document.getElementById("chat");
    const div = document.createElement("div");
    div.classList.add("message", data.sender == {{ current_user.id }} ? "me" : "other");
    div.innerHTML = data.text + "<div class='message-time'>" + data.timestamp + "</div>";
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
});
</script>

{% endblock %}
